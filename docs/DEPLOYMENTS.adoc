== Deployments

=== CI/CD Pipeline

This project uses **GitHub Actions** for automated building and releasing.

**Workflow: Build and Release** (`.github/workflows/Build and Release.yml`)

**Triggers:**
* On every push to `main` branch
* On every pull request to `main` branch

**On Pull Requests:**
* Installs dependencies
* Builds the application
* Verifies build artifacts (checks for `manifest.json`)
* Uploads build artifacts for review (retained for 7 days)

**On Push to Main:**
* Performs all the above steps, PLUS:
* Reads version from `package.json`
* Creates `zapdesk-{version}.zip` package
* Automatically publishes a GitHub release with the zip file attached
* Release includes installation instructions and links to documentation

**Creating an Automated Release:**

```bash
# 1. Update version in package.json
npm version patch  # or minor, or major

# 2. Commit and push to main
git add package.json
git commit -m "Bump version to x.x.x"
git push origin main
```

The GitHub Actions workflow will automatically build, package, and create a release at:
`https://github.com/knowall-ai/zendesk-zapdesk/releases`

**Download Release:**
* Navigate to the Releases page
* Download `zapdesk-{version}.zip`
* Install directly to Zendesk using the zip file (see detailed installation instructions below)

=== Build Process

**Development Build:**

```bash
# Install dependencies
npm install

# Run development server with hot reload
npm run dev

# Build for production
npm run build
```

**Production Build:**

```bash
# Clean previous builds
npm run clean

# Build optimized production assets
npm run build

# Package Zendesk app
zcli apps:package
```

**Build Output:**

* `/dist/assets/iframe.html` - Main application entry point
* `/dist/assets/app.js` - Bundled JavaScript (React + TypeScript)
* `/dist/assets/app.css` - Compiled CSS styles
* `/dist/manifest.json` - Zendesk app manifest
* `/dist/translations/` - Localization files
* `zapdesk-{version}.zip` - Packaged app for upload

=== Administrator Installation Instructions

This section provides step-by-step instructions for Zendesk administrators to install Zapdesk from the release zip file.

==== Prerequisites

Before installing Zapdesk, ensure you have:

* **Admin access** to your Zendesk instance
* A **Lightning Address custom field** configured (see instructions below)

==== Step 1: Download the Latest Release

1. Navigate to the GitHub Releases page: https://github.com/knowall-ai/zendesk-zapdesk/releases
2. Locate the latest release version
3. Download the `zapdesk-{version}.zip` file (e.g., `zapdesk-1.0.0.zip`)
4. Save the zip file to your local computer

==== Step 2: Create the Custom Field (First-Time Setup Only)

Before installing the app, you must create a custom user field for Lightning addresses:

1. Log into your Zendesk instance as an administrator
2. Navigate to **Admin Center** (click the gear icon in the sidebar)
3. Go to **People** → **Configuration** → **User fields**
   * Direct URL: `https://{your-subdomain}.zendesk.com/admin/people/configuration/user_fields`
4. Click **Add field** (top right corner)
5. Configure the new field with the following settings:
   * **Type**: Select `Text`
   * **Display name** (also called "Field name" in UI): Enter `lightning address`
   * **Field key**: Enter `lightning_address` (must be exactly this - case sensitive, no spaces)
   * **Description**: (Optional) "Agent's Bitcoin Lightning address for receiving tips"
   * **Required**: Leave unchecked
   * **Visible to end users**: Uncheck (internal field only)
6. Click **Save** to create the field

IMPORTANT: The **Display name** is what agents see in the UI (can be "lightning address" with a space). The **Field key** is the technical identifier used by the app and must be exactly `lightning_address` (all lowercase, one word, no spaces). The app will not function correctly with a different field key.

==== Step 3: Install the Zapdesk App to Zendesk

1. In the **Admin Center**, navigate to **Apps and integrations** → **Apps** → **Zendesk Support apps**
   * Direct URL: `https://{your-subdomain}.zendesk.com/admin/apps-integrations/apps/support-apps`
2. Click **Upload private app** (top right corner)
3. In the upload dialog:
   * Click **Choose File**
   * Select the `zapdesk-{version}.zip` file you downloaded in Step 1
   * Click **Upload**
4. Review the app details:
   * App name: Zapdesk
   * Version: {version}
   * Permissions: Read ticket data, modify tickets, read user data
5. Review the app permissions carefully
6. Click **Install** to confirm the installation

==== Step 4: Configure App Settings

After installation, you need to configure the app settings:

1. On the app installation confirmation page, or by navigating to the app settings:
   * Admin Center → Apps → Zendesk Support apps → Zapdesk → Settings
2. Configure the following parameters:

**Required Settings:**

* **Agent address field key**: Enter `user.custom_fields.lightning_address`
  - This must match the custom field created in Step 2
  - Default: `user.custom_fields.lightning_address`

**Optional Settings:**

* **Private comments**: Checkbox to control comment visibility for tip confirmations
  - Checked: Comments appear as internal notes (agents only)
  - Unchecked: Comments appear as public (visible to requester)
  - Recommended: Unchecked to acknowledge tips publicly

3. Click **Install** or **Update** to save the configuration

==== Step 5: Add Lightning Addresses to Agent Profiles

For each agent who should receive tips, add their Lightning address to their profile:

1. Navigate to **Admin Center** → **People** → **Team** → **Team members**
   * Direct URL: `https://{your-subdomain}.zendesk.com/admin/people/team/members`
2. Locate the agent in the member table
3. Click **Manage in Support** next to their name
4. On the agent profile page, scroll to the bottom
5. Find the **Lightning address** field (created in Step 2)
6. Enter the agent's Lightning address
   * Format: `user@provider.com` (similar to email)
   * Example: `agent@getalby.com`
7. Click **Save** to update the profile

Repeat this process for all agents who should receive tips.

TIP: You can use providers like Alby (getalby.com), Wallet of Satoshi, or other Lightning address services to generate Lightning addresses for your agents.

==== Step 6: Verify Installation

After completing the installation and configuration:

1. Open any Zendesk support ticket in the agent interface
2. Look for **Zapdesk** in the right sidebar under the Apps section
3. Click on the Zapdesk app icon to open the app
4. Verify the following:
   * The app loads without errors
   * Tip preset buttons are displayed with correct amounts
   * The agent's Lightning address is detected (if configured in their profile)
   * QR codes generate correctly when a payment method is selected
   * The user message input field is functional

If all checks pass, the installation is successful.

==== Troubleshooting Common Issues

**Issue: App doesn't appear in ticket sidebar**

* Solution 1: Verify the app is installed and enabled
  - Go to Admin Center → Apps → Zendesk Support apps
  - Ensure Zapdesk shows as "Enabled"
* Solution 2: Clear browser cache and hard refresh (Ctrl+F5 or Cmd+Shift+R)
* Solution 3: Check browser console for iframe or loading errors
* Solution 4: Verify your browser allows third-party iframes

**Issue: "No Lightning address found" error**

* Solution 1: Verify the custom field key is exactly `lightning_address`
  - Go to People → Configuration → User fields
  - Click on the Lightning address field
  - Confirm the Field key value is exactly `lightning_address`
* Solution 2: Check that the agent has a Lightning address in their profile
  - Go to People → Team → Team members
  - Open the agent profile
  - Verify the Lightning address field is populated
* Solution 3: Verify the "Agent address field key" setting in app configuration
  - Should be: `user.custom_fields.lightning_address`
* Solution 4: Use the fallback address setting for testing purposes

**Issue: QR codes not generating**

* Solution 1: Verify "Enable QR Mode" is checked in app settings
* Solution 2: Check browser console for JavaScript errors
* Solution 3: Verify the Lightning address format is valid (user@provider.com)
* Solution 4: Test with a known working Lightning address

**Issue: Tip confirmations not posting to tickets**

* Solution 1: Verify the app has permission to modify tickets
  - Check app permissions in Admin Center
* Solution 2: Check the "Private comments" setting in app configuration
* Solution 3: Review Zendesk audit logs for errors
  - Admin Center → Activity → Audit log
* Solution 4: Verify the agent has permission to post comments

**Issue: Payment not completing**

* Solution: This is typically a user-side issue
  - Verify the user's Lightning wallet has sufficient balance
  - Ensure the user's wallet supports BOLT11/LNURL payments
  - Check network connectivity on user's device
  - Verify the Lightning address is active and accepting payments

==== Updating Zapdesk to a Newer Version

To update an existing Zapdesk installation:

1. Download the new `zapdesk-{version}.zip` from the GitHub Releases page
2. Navigate to **Admin Center** → **Apps** → **Zendesk Support apps**
3. Locate **Zapdesk** in the installed apps list
4. Click the app name or settings icon (gear)
5. Click **Update** or **Upload new version**
6. Select the new zip file
7. Click **Upload**
8. Review the update details and any new permissions
9. Click **Update** to confirm
10. Review any new settings that may have been added
11. Update configuration as needed
12. Click **Save** to apply changes

NOTE: Existing settings and configurations are typically preserved during updates. However, review all settings after updating to ensure they are correct.

==== Uninstalling Zapdesk

To remove Zapdesk from your Zendesk instance:

1. Navigate to **Admin Center** → **Apps** → **Zendesk Support apps**
2. Locate **Zapdesk** in the installed apps list
3. Click the settings icon (gear) next to the app
4. Click **Uninstall**
5. Confirm the uninstallation when prompted
6. The app will be removed from all ticket sidebars

IMPORTANT: Uninstalling the app does NOT remove:

* The Lightning address custom field (must be deleted manually if desired)
* Historical ticket comments posted by the app
* Any configuration data stored in Zendesk

To completely remove all traces:

1. Uninstall the app (steps above)
2. Delete the custom field:
   * Go to People → Configuration → User fields
   * Find "lightning address" field
   * Click deactivate/delete
3. Historical comments remain in tickets but will no longer function

=== Environment Deployment

**Zendesk Sandbox Environment:**

1. Build the application with `npm run build`
2. Package the app with `zcli apps:package`
3. Upload to Zendesk Sandbox:
   ```bash
   zcli apps:create dist/
   ```
4. Test in Zendesk sandbox ticket sidebar
5. Verify ZAF client integration
6. Test all payment workflows

**Zendesk Production Environment:**

**Option 1: Using GitHub Release (Recommended)**

1. Complete UAT testing in Sandbox
2. Obtain deployment approval from stakeholders
3. Download the release zip from GitHub Releases page:
   ```
   https://github.com/knowall-ai/zendesk-zapdesk/releases
   ```
4. Schedule deployment window (low-traffic hours recommended)
5. Create backup of current production app version
6. Upload new version to production:
   ```bash
   zcli apps:update --path zapdesk-{version}.zip
   ```
7. Verify deployment success
8. Perform smoke testing in production
9. Monitor for errors in first 24 hours
10. Notify end-users of new version

**Option 2: Manual Build and Deploy**

1. Complete UAT testing in Sandbox
2. Obtain deployment approval from stakeholders
3. Build locally: `npm run build`
4. Schedule deployment window (low-traffic hours recommended)
5. Create backup of current production app version
6. Upload new version to production:
   ```bash
   zcli apps:update --path dist/
   ```
7. Verify deployment success
8. Perform smoke testing in production
9. Monitor for errors in first 24 hours
10. Notify end-users of new version

=== Configuration Management

**App Settings (manifest.json):**

```json
{
  "parameters": [
    {
      "name": "private_comments",
      "type": "checkbox",
      "required": false,
      "default": false
    }
  ]
}
```

**Parameter Description:**

* `private_comments`: When enabled, tip confirmation comments are posted as internal notes (visible to agents only). When disabled, comments are public (visible to requester and agents).

=== Version Management

**Versioning Strategy:**

* **Major version (X.0.0)**: Breaking changes, major feature releases
* **Minor version (0.X.0)**: New features, non-breaking changes
* **Patch version (0.0.X)**: Bug fixes, minor updates

**Automated Version Bumping:**

```bash
# Patch release (1.0.0 → 1.0.1) - Bug fixes
npm version patch

# Minor release (1.0.0 → 1.1.0) - New features
npm version minor

# Major release (1.0.0 → 2.0.0) - Breaking changes
npm version major

# Commit and push (triggers automated release)
git push origin main
```

The `npm version` command automatically:
* Updates the version in `package.json`
* Creates a git commit with the version change
* Creates a git tag (e.g., `v1.0.1`)

**Changelog Maintenance:**

* Document all changes in `CHANGELOG.md`
* Include migration notes for breaking changes
* Reference GitHub issues/pull requests
* Provide upgrade instructions

**Release Process:**

1. Update version using `npm version [patch|minor|major]`
2. Push to main branch: `git push origin main`
3. Push the tag: `git push origin --tags`
4. GitHub Actions automatically creates the release
5. Download the release zip from GitHub Releases page
6. Deploy to Zendesk using the downloaded zip file

=== Monitoring and Maintenance

**Application Health Monitoring:**

* Monitor ZAF client errors via browser console
* Track payment success/failure rates
* Track ticket posting errors
* Monitor app load times and performance

**User Feedback Collection:**

* Monitor Zendesk app reviews and ratings
* Collect user feedback via support channels
* Track feature requests and enhancement ideas
* Analyze usage patterns and adoption metrics

**Maintenance Schedule:**

* **Weekly**: Review error logs and user feedback
* **Monthly**: Dependency updates and security patches
* **Quarterly**: Feature releases and major updates
* **As needed**: Critical bug fixes and security updates

=== Rollback Procedures

**Emergency Rollback:**

1. Identify critical issue requiring rollback
2. Notify stakeholders of rollback decision
3. Restore previous version from backup:
   ```bash
   zcli apps:update --path backup/zapdesk-{previous-version}.zip
   ```
4. Verify rollback successful
5. Communicate rollback to users
6. Investigate root cause of issue
7. Plan hotfix or corrected deployment

**Rollback Validation:**

* Test core functionality after rollback
* Verify settings are preserved
* Check user data integrity
* Monitor for additional errors

=== Multi-Language Support

Zapdesk includes automatic language detection and localization based on Zendesk user preferences.

==== Supported Languages

* **English** (`en`) - Default language
* **Spanish** (`es`) - Full translation

==== How It Works

The app automatically:

1. Fetches the current user's locale from Zendesk (`currentUser.locale`)
2. Loads the appropriate translation file from `/dist/translations/`
3. Falls back to English if the language is not supported
4. Handles locale variants (e.g., `es-MX` → `es` → `en`)

==== Testing Language Changes

**For Administrators:**

To test different languages:

1. Log into Zendesk with admin account
2. Click profile icon (top right) → **View profile**
3. Click **Edit profile**
4. Change **Language** to desired language (e.g., Español)
5. Click **Save**
6. Reload any ticket page
7. Open Zapdesk app in sidebar - it will display in the selected language

**For End Users:**

Each end user's language preference is automatically detected. Users can change their language:

1. In Zendesk, click profile icon → **My profile**
2. Change **Language** preference
3. The app will automatically display in their selected language

==== Technical Implementation

**Translation Files:**

* Location: `/translations/en.json`, `/translations/es.json`
* Format: Nested JSON structure
* Loading: Dynamic import at runtime based on user locale

**Console Debugging:**

When the app loads, check browser console for:

```
[Zapdesk] User locale: es
[i18n] Loading translations for locale: es
[i18n] Loaded translations: es
```

==== Adding New Languages

To add support for additional languages:

1. **Create Translation File:**
   * Copy `translations/en.json` to `translations/{locale}.json`
   * Translate all text values (keep keys identical)
   * Maintain the same JSON structure

2. **Update Manifest:**
   * Edit `manifest.json`
   * Add locale to `supportedLocales` array:
   ```json
   "supportedLocales": ["en", "es", "fr"]
   ```

3. **Test:**
   * Build the app: `npm run build`
   * Verify translation file is in `dist/translations/`
   * Change Zendesk user language to test

4. **Deploy:**
   * Package and upload to Zendesk
   * Verify locale detection in console logs

**Important Notes:**

* Browser language settings do NOT affect the app
* Language is determined by Zendesk user profile setting
* Translation changes require rebuilding and redeploying the app
* All translation keys must match between language files
